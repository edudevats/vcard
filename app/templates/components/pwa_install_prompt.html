<!-- PWA Install Prompt Component -->
<div id="pwa-install-prompt" class="position-fixed bottom-0 start-0 end-0 bg-primary text-white p-3 shadow-lg" style="display: none; z-index: 1060; transform: translateY(100%); transition: transform 0.3s ease;">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-auto">
                <i class="fas fa-mobile-alt fa-2x"></i>
            </div>
            <div class="col">
                <h6 class="mb-1 text-white">¡Instala ATScard Digital!</h6>
                <small class="text-white-50">
                    Acceso rápido, funciona sin conexión y ocupa poco espacio
                </small>
            </div>
            <div class="col-auto">
                <button id="pwa-install-btn" class="btn btn-light btn-sm me-2">
                    <i class="fas fa-download me-1"></i>Instalar
                </button>
                <button id="pwa-install-close" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PWA Update Available Prompt -->
<div id="pwa-update-prompt" class="position-fixed top-0 start-0 end-0 bg-warning text-dark p-2 shadow" style="display: none; z-index: 1061;">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-auto">
                <i class="fas fa-sync-alt"></i>
            </div>
            <div class="col">
                <small><strong>Nueva versión disponible</strong></small>
            </div>
            <div class="col-auto">
                <button id="pwa-update-btn" class="btn btn-sm btn-warning">
                    Actualizar
                </button>
                <button id="pwa-update-close" class="btn-close btn-sm" aria-label="Cerrar"></button>
            </div>
        </div>
    </div>
</div>

<!-- Offline Indicator -->
<div id="pwa-offline-indicator" class="position-fixed top-0 start-0 end-0 bg-orange text-white p-2 text-center" style="display: none; z-index: 1062; background-color: #ff6b35;">
    <small>
        <i class="fas fa-wifi me-1"></i>
        Sin conexión - Trabajando en modo offline
    </small>
</div>

<!-- PWA Installation Success -->
<div id="pwa-install-success" class="position-fixed top-50 start-50 translate-middle bg-success text-white p-4 rounded shadow-lg text-center" style="display: none; z-index: 1063; min-width: 300px;">
    <i class="fas fa-check-circle fa-3x mb-3"></i>
    <h5 class="mb-2">¡App Instalada!</h5>
    <p class="mb-3">ATScard Digital se ha instalado correctamente en tu dispositivo</p>
    <button id="pwa-success-close" class="btn btn-light btn-sm">
        <i class="fas fa-check me-1"></i>Entendido
    </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // PWA Install Prompt Logic
    const installPrompt = document.getElementById('pwa-install-prompt');
    const installBtn = document.getElementById('pwa-install-btn');
    const installClose = document.getElementById('pwa-install-close');
    const updatePrompt = document.getElementById('pwa-update-prompt');
    const updateBtn = document.getElementById('pwa-update-btn');
    const updateClose = document.getElementById('pwa-update-close');
    const offlineIndicator = document.getElementById('pwa-offline-indicator');
    const installSuccess = document.getElementById('pwa-install-success');
    const successClose = document.getElementById('pwa-success-close');

    let deferredPrompt = null;
    let isInstalled = false;

    // Check if app is already installed
    function checkIfInstalled() {
        // Check for display mode
        if (window.matchMedia('(display-mode: standalone)').matches) {
            isInstalled = true;
            return true;
        }
        
        // Check for iOS standalone
        if (window.navigator.standalone === true) {
            isInstalled = true;
            return true;
        }
        
        return false;
    }

    // Show install prompt
    function showInstallPrompt() {
        if (isInstalled || !deferredPrompt) return;
        
        installPrompt.style.display = 'block';
        setTimeout(() => {
            installPrompt.style.transform = 'translateY(0)';
        }, 100);
    }

    // Hide install prompt
    function hideInstallPrompt() {
        installPrompt.style.transform = 'translateY(100%)';
        setTimeout(() => {
            installPrompt.style.display = 'none';
        }, 300);
    }

    // Show install success
    function showInstallSuccess() {
        installSuccess.style.display = 'block';
        setTimeout(() => {
            installSuccess.style.display = 'none';
        }, 4000);
    }

    // Install app
    async function installApp() {
        if (!deferredPrompt) {
            showInstallInstructions();
            return;
        }

        try {
            deferredPrompt.prompt();
            const choiceResult = await deferredPrompt.userChoice;
            
            if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
                hideInstallPrompt();
                showInstallSuccess();
            } else {
                console.log('User dismissed the install prompt');
            }
            
            deferredPrompt = null;
        } catch (error) {
            console.error('Error installing app:', error);
            showInstallInstructions();
        }
    }

    // Show manual install instructions
    function showInstallInstructions() {
        const isAndroid = /Android/.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isChrome = /Chrome/.test(navigator.userAgent);
        
        let instructions = '';
        
        if (isAndroid && isChrome) {
            instructions = `
                <div class="alert alert-info">
                    <h6><i class="fab fa-chrome me-2"></i>Para instalar en Android Chrome:</h6>
                    <ol class="mb-0 ps-3">
                        <li>Toca el menú (⋮) en la esquina superior derecha</li>
                        <li>Selecciona "Agregar a pantalla de inicio" o "Instalar app"</li>
                        <li>Toca "Instalar" para confirmar</li>
                    </ol>
                </div>
            `;
        } else if (isIOS) {
            instructions = `
                <div class="alert alert-info">
                    <h6><i class="fab fa-safari me-2"></i>Para instalar en iOS Safari:</h6>
                    <ol class="mb-0 ps-3">
                        <li>Toca el botón Compartir <i class="fas fa-share"></i></li>
                        <li>Desplázate y selecciona "Agregar a pantalla de inicio"</li>
                        <li>Toca "Agregar" para instalar</li>
                    </ol>
                </div>
            `;
        } else {
            instructions = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-mobile-alt me-2"></i>Para instalar la app:</h6>
                    <p class="mb-0">
                        Busca la opción "Agregar a pantalla de inicio" o "Instalar app" 
                        en el menú de tu navegador.
                    </p>
                </div>
            `;
        }

        // Show modal with instructions
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-download me-2"></i>Instalar ATScard Digital
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${instructions}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', () => {
            modal.remove();
        });
    }

    // Event Listeners
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Show install prompt after a delay if not installed
        if (!checkIfInstalled()) {
            setTimeout(() => {
                showInstallPrompt();
            }, 3000);
        }
    });

    window.addEventListener('appinstalled', () => {
        console.log('PWA installed');
        isInstalled = true;
        hideInstallPrompt();
        showInstallSuccess();
        deferredPrompt = null;
    });

    // Button events
    installBtn?.addEventListener('click', installApp);
    installClose?.addEventListener('click', hideInstallPrompt);
    successClose?.addEventListener('click', () => {
        installSuccess.style.display = 'none';
    });

    // Update prompt events
    updateBtn?.addEventListener('click', () => {
        if (window.pwaManager) {
            window.pwaManager.updateApp();
        }
        updatePrompt.style.display = 'none';
    });

    updateClose?.addEventListener('click', () => {
        updatePrompt.style.display = 'none';
    });

    // Offline/online events
    window.addEventListener('offline', () => {
        offlineIndicator.style.display = 'block';
    });

    window.addEventListener('online', () => {
        offlineIndicator.style.display = 'none';
    });

    // Initial offline check
    if (!navigator.onLine) {
        offlineIndicator.style.display = 'block';
    }

    // Check if already installed
    checkIfInstalled();

    // Global functions for external use
    window.showPWAInstallPrompt = showInstallPrompt;
    window.hidePWAInstallPrompt = hideInstallPrompt;
    window.showPWAUpdatePrompt = () => {
        updatePrompt.style.display = 'block';
    };
});
</script>

<style>
/* PWA Specific Styles */
.bg-orange {
    background-color: #ff6b35 !important;
}

@media (display-mode: standalone) {
    /* Styles when running as PWA */
    .navbar {
        padding-top: env(safe-area-inset-top, 0);
    }
    
    .container {
        padding-left: env(safe-area-inset-left, 15px);
        padding-right: env(safe-area-inset-right, 15px);
    }
}

/* Animation for prompts */
#pwa-install-prompt {
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
    }
    to {
        transform: translateY(0);
    }
}

/* Responsive adjustments */
@media (max-width: 576px) {
    #pwa-install-prompt .row {
        text-align: center;
    }
    
    #pwa-install-prompt .col-auto {
        margin-bottom: 0.5rem;
    }
    
    #pwa-install-prompt .col-auto:last-child {
        margin-bottom: 0;
    }
}
</style>