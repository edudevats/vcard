{% extends "base.html" %}

{% block title %}Cola de Espera - {{ system.business_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;">
    <div class="text-center mb-4">
        <h1 class="text-white mb-2">{{ system.business_name }}</h1>
        <p class="text-white-50">Sistema de Turnos</p>
    </div>

    <!-- Current Appointment -->
    <div class="row justify-content-center mb-4">
        <div class="col-lg-8">
            <div class="card shadow-lg">
                <div class="card-header bg-success text-white text-center py-3">
                    <h4 class="mb-0">
                        <i class="fas fa-user-md me-2"></i>Turno Actual
                    </h4>
                </div>
                <div class="card-body text-center py-5" id="currentAppointment">
                    {% if current_appointment %}
                        <div class="current-ticket" style="color: {{ current_appointment.type.color }};">
                            {{ current_appointment.ticket_number }}
                        </div>
                        <div class="mt-3">
                            <span class="badge badge-lg" style="background-color: {{ current_appointment.type.color }}; font-size: 1.2rem;">
                                {{ current_appointment.type.name }}
                            </span>
                        </div>
                        {% if system.display_mode == 'detailed' %}
                            <h4 class="mt-3">{{ current_appointment.patient_name }}</h4>
                        {% endif %}
                    {% else %}
                        <div class="text-muted">
                            <i class="fas fa-clock fa-3x mb-3"></i>
                            <p>Esperando próximo turno...</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Waiting Queue -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white text-center py-3">
                    <h4 class="mb-0">
                        <i class="fas fa-list me-2"></i>Próximos Turnos
                        <span class="badge bg-light text-primary ms-2" id="waitingCount">
                            {{ waiting_appointments|length }}
                        </span>
                    </h4>
                </div>
                <div class="card-body p-0" id="waitingQueue">
                    {% if waiting_appointments %}
                        <div class="list-group list-group-flush">
                            {% for appointment in waiting_appointments %}
                                <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                                    <div class="d-flex align-items-center">
                                        <div class="ticket-number-small me-3" style="color: {{ appointment.type.color }};">
                                            {{ appointment.ticket_number }}
                                        </div>
                                        <div>
                                            <span class="badge" style="background-color: {{ appointment.type.color }};">
                                                {{ appointment.type.name }}
                                            </span>
                                            {% if system.display_mode == 'detailed' %}
                                                <div class="mt-1">{{ appointment.patient_name }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-muted">
                                        <i class="fas fa-clock me-1"></i>{{ appointment.get_waiting_time() }} min
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>No hay turnos en espera</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Take Appointment Button -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-8 text-center">
            <a href="{{ url_for('public.appointments_public', username=username) }}"
               class="btn btn-lg btn-light shadow">
                <i class="fas fa-plus-circle me-2"></i>Tomar Turno
            </a>
        </div>
    </div>
</div>

<style>
.current-ticket {
    font-size: 6rem;
    font-weight: bold;
    line-height: 1;
}

.ticket-number-small {
    font-size: 2rem;
    font-weight: bold;
    min-width: 80px;
}

@media (max-width: 768px) {
    .current-ticket {
        font-size: 4rem;
    }
    .ticket-number-small {
        font-size: 1.5rem;
        min-width: 60px;
    }
}
</style>

<script>
// Auto-refresh every 5 seconds
function updateQueue() {
    fetch('{{ url_for("public.appointments_queue_json", username=username) }}')
        .then(response => response.json())
        .then(data => {
            // Update current appointment
            const currentDiv = document.getElementById('currentAppointment');
            if (data.current) {
                currentDiv.innerHTML = `
                    <div class="current-ticket" style="color: ${data.current.type_color};">
                        ${data.current.ticket_number}
                    </div>
                    <div class="mt-3">
                        <span class="badge badge-lg" style="background-color: ${data.current.type_color}; font-size: 1.2rem;">
                            ${data.current.type_name}
                        </span>
                    </div>
                    ${data.current.patient_name ? `<h4 class="mt-3">${data.current.patient_name}</h4>` : ''}
                `;
            } else {
                currentDiv.innerHTML = `
                    <div class="text-muted">
                        <i class="fas fa-clock fa-3x mb-3"></i>
                        <p>Esperando próximo turno...</p>
                    </div>
                `;
            }

            // Update waiting count
            document.getElementById('waitingCount').textContent = data.waiting_count;

            // Update waiting queue
            const queueDiv = document.getElementById('waitingQueue');
            if (data.waiting.length > 0) {
                let html = '<div class="list-group list-group-flush">';
                data.waiting.forEach(apt => {
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <div class="d-flex align-items-center">
                                <div class="ticket-number-small me-3" style="color: ${apt.type_color};">
                                    ${apt.ticket_number}
                                </div>
                                <div>
                                    <span class="badge" style="background-color: ${apt.type_color};">
                                        ${apt.type_name}
                                    </span>
                                    ${apt.patient_name ? `<div class="mt-1">${apt.patient_name}</div>` : ''}
                                </div>
                            </div>
                            <div class="text-muted">
                                <i class="fas fa-clock me-1"></i>${apt.waiting_time} min
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                queueDiv.innerHTML = html;
            } else {
                queueDiv.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No hay turnos en espera</p>
                    </div>
                `;
            }
        })
        .catch(error => console.error('Error updating queue:', error));
}

// Update every 5 seconds
setInterval(updateQueue, 5000);
</script>
{% endblock %}
