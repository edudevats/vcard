{% extends "base.html" %}

{% block title %}Personalizar Tema - {{ card.name }}{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Preload common Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Initial font -->
    <link id="google-fonts-link" href="https://fonts.googleapis.com/css2?family={{ card.theme.font_family.replace(' ', '+') }}:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap" rel="stylesheet">
    <!-- Preload popular fonts for faster switching -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap">
{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="sidebar">
            <h5 class="mb-3">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </h5>
            <nav class="nav flex-column">
                <a class="nav-link" href="{{ url_for('dashboard.index') }}">
                    <i class="fas fa-home me-2"></i>Inicio
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.edit_card', id=card.id) }}">
                    <i class="fas fa-edit me-2"></i>Editar Tarjeta
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.card_services', id=card.id) }}">
                    <i class="fas fa-concierge-bell me-2"></i>Servicios
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.card_products', id=card.id) }}">
                    <i class="fas fa-box me-2"></i>Productos
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.card_gallery', id=card.id) }}">
                    <i class="fas fa-images me-2"></i>Galería
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.card_avatar', id=card.id) }}">
                    <i class="fas fa-user-circle me-2"></i>Avatar
                </a>
                <a class="nav-link active" href="{{ url_for('dashboard.card_theme', id=card.id) }}">
                    <i class="fas fa-palette me-2"></i>Personalizar
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.card_qr', id=card.id) }}">
                    <i class="fas fa-qrcode me-2"></i>Código QR
                </a>
            </nav>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-md-9">
        <div class="main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-palette me-2"></i>Personalizar Tema
                    <small class="text-muted">- {{ card.name }}</small>
                </h2>
                {% if card.is_public %}
                    <a href="{{ card.get_public_url() }}" target="_blank" class="btn btn-outline-success">
                        <i class="fas fa-external-link-alt me-1"></i>Ver Pública
                    </a>
                {% endif %}
            </div>
            
            <div class="row">
                <!-- Theme Controls -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-sliders-h me-2"></i>Configuración del Tema
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" id="theme-form">
                                {{ form.hidden_tag() }}
                                
                                <!-- Colors -->
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-paint-brush me-2"></i>Colores
                                </h6>
                                
                                <div class="row mb-3">
                                    <div class="col-4">
                                        {{ form.primary_color.label(class="form-label") }}
                                        {{ form.primary_color(onchange="updatePreview()") }}
                                        <small class="form-text">Principal</small>
                                    </div>
                                    <div class="col-4">
                                        {{ form.secondary_color.label(class="form-label") }}
                                        {{ form.secondary_color(onchange="updatePreview()") }}
                                        <small class="form-text">Secundario</small>
                                    </div>
                                    <div class="col-4">
                                        {{ form.accent_color.label(class="form-label") }}
                                        {{ form.accent_color(onchange="updatePreview()") }}
                                        <small class="form-text">Acento</small>
                                    </div>
                                </div>
                                
                                <!-- Typography -->
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-font me-2"></i>Tipografía
                                </h6>
                                
                                <div class="mb-3">
                                    {{ form.font_family.label(class="form-label") }}
                                    {{ form.font_family(onchange="updatePreview()") }}
                                </div>
                                
                                <!-- Layout -->
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-layout me-2"></i>Diseño
                                </h6>
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        {{ form.layout.label(class="form-label") }}
                                        {{ form.layout(onchange="updatePreview()") }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.avatar_shape.label(class="form-label") }}
                                        {{ form.avatar_shape(onchange="updatePreview()") }}
                                        <div class="form-text">
                                            <small>
                                                <i class="fas fa-info-circle me-1"></i>
                                                <strong>Rectangular:</strong> Ideal para logos y marcas
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Color Presets -->
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-palette me-2"></i>Paletas Predefinidas
                                </h6>
                                
                                <div class="row mb-4">
                                    <div class="col-3">
                                        <button type="button" class="btn btn-outline-secondary w-100 p-2" 
                                                onclick="applyPreset('#1e40af', '#3b82f6', '#60a5fa')" title="Azul Clásico">
                                            <div class="d-flex">
                                                <div style="width: 20px; height: 20px; background: #1e40af; margin: 1px;"></div>
                                                <div style="width: 20px; height: 20px; background: #3b82f6; margin: 1px;"></div>
                                                <div style="width: 20px; height: 20px; background: #60a5fa; margin: 1px;"></div>
                                            </div>
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="btn btn-outline-secondary w-100 p-2" 
                                                onclick="applyPreset('#ec4899', '#f472b6', '#fbcfe8')" title="Rosa Moderno">
                                            <div class="d-flex">
                                                <div style="width: 20px; height: 20px; background: #ec4899; margin: 1px;"></div>
                                                <div style="width: 20px; height: 20px; background: #f472b6; margin: 1px;"></div>
                                                <div style="width: 20px; height: 20px; background: #fbcfe8; margin: 1px;"></div>
                                            </div>
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="btn btn-outline-secondary w-100 p-2" 
                                                onclick="applyPreset('#059669', '#10b981', '#6ee7b7')" title="Verde Minimalista">
                                            <div class="d-flex">
                                                <div style="width: 20px; height: 20px; background: #059669; margin: 1px;"></div>
                                                <div style="width: 20px; height: 20px; background: #10b981; margin: 1px;"></div>
                                                <div style="width: 20px; height: 20px; background: #6ee7b7; margin: 1px;"></div>
                                            </div>
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button type="button" class="btn btn-outline-secondary w-100 p-2" 
                                                onclick="applyPreset('#7c3aed', '#8b5cf6', '#c4b5fd')" title="Púrpura Elegante">
                                            <div class="d-flex">
                                                <div style="width: 20px; height: 20px; background: #7c3aed; margin: 1px;"></div>
                                                <div style="width: 20px; height: 20px; background: #8b5cf6; margin: 1px;"></div>
                                                <div style="width: 20px; height: 20px; background: #c4b5fd; margin: 1px;"></div>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    {{ form.submit() }}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Live Preview -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-eye me-2"></i>Vista Previa
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="preview-container" style="
                                background: linear-gradient(135deg, var(--preview-primary, {{ card.theme.primary_color }}), var(--preview-secondary, {{ card.theme.secondary_color }}));
                                min-height: 500px;
                                padding: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <div id="preview-card" class="preview-card" style="
                                    max-width: 300px;
                                    width: 100%;
                                    text-align: center;
                                    font-family: var(--preview-font, '{{ card.theme.font_family }}'), sans-serif;
                                    transition: all 0.3s ease;
                                ">
                                    <!-- Avatar Preview -->
                                    <div id="preview-avatar" style="
                                        width: 80px;
                                        height: 80px;
                                        margin: 0 auto 15px;
                                        overflow: hidden;
                                        border: 3px solid white;
                                        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                                        background: #f8f9fa;
                                    ">
                                        {% if card.has_avatar() %}
                                            <img id="preview-avatar-img" src="{{ url_for('static', filename='uploads/' + card.get_avatar_path()) }}" 
                                                 style="width: 100%; height: 100%; object-fit: cover;" alt="Avatar">
                                        {% else %}
                                            <div class="w-100 h-100 d-flex align-items-center justify-content-center" 
                                                 style="background: linear-gradient(135deg, var(--preview-primary, {{ card.theme.primary_color }}), var(--preview-secondary, {{ card.theme.secondary_color }})); color: white; font-size: 30px;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <h3 id="preview-title" style="
                                        color: var(--preview-primary, {{ card.theme.primary_color }});
                                        font-size: 18px;
                                        font-weight: 700;
                                        margin-bottom: 5px;
                                    ">{{ card.title or card.name }}</h3>
                                    
                                    {% if card.job_title %}
                                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">{{ card.job_title }}</p>
                                    {% endif %}
                                    
                                    <div id="preview-buttons" class="preview-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                                        <div id="btn-contact" class="preview-btn" style="
                                            color: white;
                                            padding: 8px 15px;
                                            font-size: 12px;
                                            font-weight: 600;
                                            transition: all 0.3s ease;
                                        ">CONTACTO</div>
                                        
                                        <div id="btn-services" class="preview-btn" style="
                                            color: white;
                                            padding: 8px 15px;
                                            font-size: 12px;
                                            font-weight: 600;
                                            transition: all 0.3s ease;
                                        ">SERVICIOS</div>
                                        
                                        <div id="btn-outline" class="preview-btn" style="
                                            background: transparent;
                                            color: var(--preview-primary, {{ card.theme.primary_color }});
                                            padding: 8px 15px;
                                            font-size: 12px;
                                            font-weight: 600;
                                            transition: all 0.3s ease;
                                        ">UBICACIÓN</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updatePreview() {
    const primary = document.getElementById('primary_color').value;
    const secondary = document.getElementById('secondary_color').value;
    const accent = document.getElementById('accent_color').value;
    const font = document.getElementById('font_family').value;
    const layout = document.getElementById('layout').value;
    const avatarShape = document.getElementById('avatar_shape').value;
    
    // Update CSS custom properties
    document.documentElement.style.setProperty('--preview-primary', primary);
    document.documentElement.style.setProperty('--preview-secondary', secondary);
    document.documentElement.style.setProperty('--preview-accent', accent);
    document.documentElement.style.setProperty('--preview-font', font);
    
    // Update Google Fonts dynamically
    const encodedFont = font.replace(/\s+/g, '+');
    const fontUrl = `https://fonts.googleapis.com/css2?family=${encodedFont}:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap`;
    
    // Remove existing dynamic font link
    const existingDynamicLink = document.getElementById('dynamic-font-link');
    if (existingDynamicLink) {
        existingDynamicLink.remove();
    }
    
    // Create new font link with unique ID
    const newFontLink = document.createElement('link');
    newFontLink.id = 'dynamic-font-link';
    newFontLink.rel = 'stylesheet';
    newFontLink.href = fontUrl;
    document.head.appendChild(newFontLink);
    
    console.log('Loading font:', font, '-> URL:', fontUrl);
    
    // Apply font with a small delay to ensure loading
    setTimeout(() => {
        document.documentElement.style.setProperty('--preview-font', `'${font}'`);
        const previewCard = document.getElementById('preview-card');
        if (previewCard) {
            previewCard.style.fontFamily = `'${font}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif`;
        }
        console.log('Applied font:', font);
    }, 100);
    
    // Update card layout styles
    const previewCard = document.getElementById('preview-card');
    const avatar = document.getElementById('preview-avatar');
    const btnContact = document.getElementById('btn-contact');
    const btnServices = document.getElementById('btn-services');
    const btnOutline = document.getElementById('btn-outline');
    
    // Font is applied above with setTimeout
    
    // Apply layout-specific styles
    if (layout === 'classic') {
        // Classic layout
        previewCard.style.background = 'white';
        previewCard.style.borderRadius = '15px';
        previewCard.style.padding = '25px 20px';
        previewCard.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.1)';
        previewCard.style.border = `2px solid ${primary}20`;
        previewCard.style.backdropFilter = 'none';
        
        // Button styles for classic
        [btnContact, btnServices, btnOutline].forEach(btn => {
            btn.style.borderRadius = '8px';
            btn.style.textTransform = 'none';
            btn.style.letterSpacing = '0';
        });
        
        btnContact.style.background = primary;
        btnServices.style.background = secondary;
        btnOutline.style.border = `2px solid ${primary}`;
        
    } else if (layout === 'minimal') {
        // Minimal layout
        previewCard.style.background = 'white';
        previewCard.style.borderRadius = '0';
        previewCard.style.padding = '30px 25px';
        previewCard.style.boxShadow = 'none';
        previewCard.style.border = '1px solid #e0e0e0';
        previewCard.style.backdropFilter = 'none';
        
        // Button styles for minimal
        [btnContact, btnServices, btnOutline].forEach(btn => {
            btn.style.borderRadius = '0';
            btn.style.textTransform = 'none';
            btn.style.letterSpacing = '0';
            btn.style.fontWeight = '500';
        });
        
        btnContact.style.background = primary;
        btnServices.style.background = secondary;
        btnOutline.style.border = `1px solid ${primary}`;
        
    } else {
        // Modern layout (default)
        previewCard.style.background = 'rgba(255, 255, 255, 0.95)';
        previewCard.style.borderRadius = '30px';
        previewCard.style.padding = '30px 25px';
        previewCard.style.boxShadow = '0 25px 50px rgba(0, 0, 0, 0.2)';
        previewCard.style.border = 'none';
        previewCard.style.backdropFilter = 'blur(10px)';
        
        // Button styles for modern
        [btnContact, btnServices, btnOutline].forEach(btn => {
            btn.style.borderRadius = '20px';
            btn.style.textTransform = 'uppercase';
            btn.style.letterSpacing = '1px';
            btn.style.fontWeight = '600';
        });
        
        btnContact.style.background = `linear-gradient(135deg, ${primary}, ${secondary})`;
        btnServices.style.background = `linear-gradient(135deg, ${secondary}, ${accent})`;
        btnOutline.style.border = `2px solid ${primary}50`;
    }
    
    // Update avatar shape
    const avatarImg = document.getElementById('preview-avatar-img');
    
    if (avatarShape === 'circle') {
        avatar.style.borderRadius = '50%';
        avatar.style.width = '80px';
        avatar.style.height = '80px';
        avatar.style.padding = '0';
        avatar.style.background = '#f8f9fa';
        if (avatarImg) avatarImg.style.objectFit = 'cover';
    } else if (avatarShape === 'rounded') {
        avatar.style.borderRadius = '20px';
        avatar.style.width = '80px';
        avatar.style.height = '80px';
        avatar.style.padding = '0';
        avatar.style.background = '#f8f9fa';
        if (avatarImg) avatarImg.style.objectFit = 'cover';
    } else if (avatarShape === 'rectangle') {
        avatar.style.borderRadius = '12px';
        avatar.style.width = '220px';
        avatar.style.height = '120px';
        avatar.style.background = 'white';
        avatar.style.padding = '10px';
        if (avatarImg) avatarImg.style.objectFit = 'contain';
    } else {
        avatar.style.borderRadius = '8px';
        avatar.style.width = '80px';
        avatar.style.height = '80px';
        avatar.style.padding = '0';
        avatar.style.background = '#f8f9fa';
        if (avatarImg) avatarImg.style.objectFit = 'cover';
    }
    
    // Convert hex to RGB for border colors
    const hexToRgb = (hex) => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    };
    
    const primaryRgb = hexToRgb(primary);
    if (primaryRgb) {
        document.documentElement.style.setProperty('--preview-primary-rgb', `${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}`);
    }
}

function applyPreset(primary, secondary, accent) {
    document.getElementById('primary_color').value = primary;
    document.getElementById('secondary_color').value = secondary;
    document.getElementById('accent_color').value = accent;
    updatePreview();
}

// Initialize preview on page load
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
});
</script>

<style>
.form-control[type="color"] {
    height: 40px;
    padding: 2px;
}

.preview-card {
    transition: all 0.3s ease;
}

#preview-container {
    transition: background 0.3s ease;
}
</style>
{% endblock %}