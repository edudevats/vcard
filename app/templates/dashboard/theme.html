{% extends "base.html" %}

{% block title %}Personalizar Tema - {{ card.name }}{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Preload common Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Initial font -->
    <link id="google-fonts-link" href="https://fonts.googleapis.com/css2?family={{ card.theme.font_family.replace(' ', '+') }}:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap" rel="stylesheet">
    <!-- Preload popular fonts for faster switching -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap">
{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="sidebar">
            <h5 class="mb-3">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </h5>
            <nav class="nav flex-column">
                <a class="nav-link" href="{{ url_for('dashboard.index') }}">
                    <i class="fas fa-home me-2"></i>Inicio
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.edit_card', id=card.id) }}">
                    <i class="fas fa-edit me-2"></i>Editar Tarjeta
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.card_services', id=card.id) }}">
                    <i class="fas fa-concierge-bell me-2"></i>Servicios
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.card_products', id=card.id) }}">
                    <i class="fas fa-box me-2"></i>Productos
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.card_gallery', id=card.id) }}">
                    <i class="fas fa-images me-2"></i>Galería
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.card_avatar', id=card.id) }}">
                    <i class="fas fa-user-circle me-2"></i>Avatar
                </a>
                <a class="nav-link active" href="{{ url_for('dashboard.card_theme', id=card.id) }}">
                    <i class="fas fa-palette me-2"></i>Personalizar
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.card_social_networks', id=card.id) }}">
                    <i class="fas fa-share-alt me-2"></i>Redes Sociales
                </a>
                <a class="nav-link" href="{{ url_for('dashboard.card_qr', id=card.id) }}">
                    <i class="fas fa-qrcode me-2"></i>Código QR
                </a>
            </nav>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-md-9">
        <div class="main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-palette me-2"></i>Personalizar Tema
                    <small class="text-muted">- {{ card.name }}</small>
                </h2>
                {% if card.is_public %}
                    <a href="{{ card.get_public_url() }}" target="_blank" class="btn btn-outline-success">
                        <i class="fas fa-external-link-alt me-1"></i>Ver Pública
                    </a>
                {% endif %}
            </div>
            
            <!-- Template Selection -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>Seleccionar Plantilla
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Elige el diseño base para tu tarjeta. Cada plantilla ofrece un estilo completamente diferente.</p>
                    <div class="row g-3">
                        {% for template_name in available_templates %}
                        <div class="col-md-6">
                            <div class="card template-option {% if current_template == template_name %}border-primary bg-primary bg-opacity-10{% endif %}" 
                                 data-template="{{ template_name }}">
                                <div class="card-body text-center">
                                    <div class="template-preview mb-3" style="height: 120px;">
                                        {% if template_name == 'classic' %}
                                        <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 20px; height: 100%; display: flex; align-items: center; justify-content: center;">
                                            <div style="background: white; border-radius: 15px; padding: 15px; text-align: center; width: 80%;">
                                                <div style="width: 30px; height: 30px; background: #ddd; border-radius: 50%; margin: 0 auto 8px;"></div>
                                                <div style="height: 8px; background: #6366f1; border-radius: 4px; margin-bottom: 5px;"></div>
                                                <div style="height: 6px; background: #ddd; border-radius: 3px; margin-bottom: 3px;"></div>
                                                <div style="height: 6px; background: #ddd; border-radius: 3px; width: 70%;"></div>
                                            </div>
                                        </div>
                                        {% elif template_name == 'business' %}
                                        <div style="background: linear-gradient(135deg, #1e40af, #3b82f6); border-radius: 15px; height: 100%; display: flex; align-items: center; justify-content: center;">
                                            <div style="background: white; border-radius: 10px; padding: 12px; width: 90%; height: 80%; display: flex;">
                                                <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                                    <div style="height: 8px; background: #1e40af; border-radius: 4px; margin-bottom: 6px; width: 80%;"></div>
                                                    <div style="height: 6px; background: #ddd; border-radius: 3px; margin-bottom: 4px; width: 90%;"></div>
                                                    <div style="height: 6px; background: #ddd; border-radius: 3px; width: 60%;"></div>
                                                </div>
                                                <div style="width: 35px; height: 35px; background: #ddd; border-radius: 50%; margin-left: 10px;"></div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <h6 class="card-title">
                                        {{ template_name.title() }}
                                        {% if current_template == template_name %}
                                        <span class="badge bg-primary ms-2">Actual</span>
                                        {% endif %}
                                    </h6>
                                    
                                    <p class="small text-muted mb-3">
                                        {% if template_name == 'classic' %}
                                        Diseño vertical tradicional, perfecto para la mayoría de profesionales
                                        {% elif template_name == 'business' %}
                                        Diseño horizontal estilo tarjeta de negocio, ideal para empresarios
                                        {% endif %}
                                    </p>
                                    
                                    {% if current_template != template_name %}
                                    <button class="btn btn-sm btn-outline-primary select-template" data-template="{{ template_name }}">
                                        <i class="fas fa-exchange-alt me-1"></i>Cambiar a {{ template_name.title() }}
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            
            <div class="row">
                <!-- Theme Controls -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-sliders-h me-2"></i>Configuración del Tema
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" id="theme-form">
                                {{ form.hidden_tag() }}
                                
                                <!-- Colors -->
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-paint-brush me-2"></i>Colores
                                </h6>
                                
                                <!-- Predefined Color Palettes -->
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-palette me-2"></i>Paletas Predefinidas
                                </h6>
                                
                                <!-- Professional Palettes -->
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold text-muted">PROFESIONALES</label>
                                    <div class="row g-2">
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#1e40af', '#3b82f6', '#60a5fa', '#ffffff')" title="Ejecutivo - Azules profesionales para negocios">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #1e40af; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #3b82f6; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #60a5fa; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Ejecutivo</small>
                                            </button>
                                        </div>
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#7c3aed', '#a855f7', '#c084fc', '#ffffff')" title="Creativo - Púrpuras vibrantes para creativos">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #7c3aed; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #a855f7; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #c084fc; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Creativo</small>
                                            </button>
                                        </div>
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#374151', '#6b7280', '#9ca3af', '#ffffff')" title="Elegante - Grises sofisticados y minimalistas">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #374151; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #6b7280; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #9ca3af; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Elegante</small>
                                            </button>
                                        </div>
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#059669', '#10b981', '#34d399', '#ffffff')" title="Médico - Verdes confiables para salud">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #059669; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #10b981; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #34d399; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Médico</small>
                                            </button>
                                        </div>
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#0f172a', '#475569', '#06b6d4', '#ffffff')" title="Tecnología - Oscuros modernos para tech">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #0f172a; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #475569; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #06b6d4; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Tecnología</small>
                                            </button>
                                        </div>
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#ec4899', '#f472b6', '#f9a8d4', '#ffffff')" title="Belleza - Rosas suaves para belleza y spa">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #ec4899; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #f472b6; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #f9a8d4; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Belleza</small>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Business Palettes -->
                                <div class="mb-4">
                                    <label class="form-label small fw-semibold text-muted">NEGOCIOS</label>
                                    <div class="row g-2">
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#1f2937', '#374151', '#6b7280', '#ffffff')" title="Corporativo - Formal para empresas grandes">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #1f2937; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #374151; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #6b7280; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Corporativo</small>
                                            </button>
                                        </div>
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#0369a1', '#0284c7', '#0ea5e9', '#ffffff')" title="Consultor - Profesional para consultores">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #0369a1; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #0284c7; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #0ea5e9; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Consultor</small>
                                            </button>
                                        </div>
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#166534', '#15803d', '#16a34a', '#ffffff')" title="Financiero - Verdes confiables para finanzas">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #166534; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #15803d; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #16a34a; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Financiero</small>
                                            </button>
                                        </div>
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#b45309', '#d97706', '#f59e0b', '#ffffff')" title="Inmobiliario - Naranjas para bienes raíces">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #b45309; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #d97706; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #f59e0b; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Inmobiliario</small>
                                            </button>
                                        </div>
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#7c2d12', '#991b1b', '#dc2626', '#ffffff')" title="Lujo - Rojos elegantes para marcas premium">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #7c2d12; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #991b1b; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #dc2626; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Lujo</small>
                                            </button>
                                        </div>
                                        <div class="col-6 col-lg-4">
                                            <button type="button" class="btn btn-outline-secondary w-100 p-2 palette-btn" 
                                                    onclick="applyPreset('#1d4ed8', '#3b82f6', '#60a5fa', '#ffffff')" title="Educación - Azules académicos">
                                                <div class="d-flex justify-content-center mb-1">
                                                    <div style="width: 18px; height: 18px; background: #1d4ed8; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #3b82f6; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                    <div style="width: 18px; height: 18px; background: #60a5fa; border-radius: 50%; margin: 1px; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                                </div>
                                                <small class="d-block">Educación</small>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Manual Color Selection -->
                                <div class="mb-3">
                                    <label class="form-label">Personalización Manual</label>
                                    <div class="row">
                                        <div class="col-4">
                                            {{ form.primary_color.label(class="form-label small") }}
                                            {{ form.primary_color(onchange="updatePreview()") }}
                                            <small class="form-text">Principal</small>
                                        </div>
                                        <div class="col-4">
                                            {{ form.secondary_color.label(class="form-label small") }}
                                            {{ form.secondary_color(onchange="updatePreview()") }}
                                            <small class="form-text">Secundario</small>
                                        </div>
                                        <div class="col-4">
                                            {{ form.accent_color.label(class="form-label small") }}
                                            {{ form.accent_color(onchange="updatePreview()") }}
                                            <small class="form-text">Acento</small>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4">
                                            {{ form.avatar_border_color.label(class="form-label small") }}
                                            {{ form.avatar_border_color(onchange="updatePreview()") }}
                                            <small class="form-text">Borde del Avatar</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Typography -->
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-font me-2"></i>Tipografía
                                </h6>
                                
                                <div class="mb-3">
                                    {{ form.font_family.label(class="form-label") }}
                                    {{ form.font_family(onchange="updatePreview()") }}
                                </div>
                                
                                <!-- Layout -->
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-layout me-2"></i>Diseño
                                </h6>
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        {{ form.layout.label(class="form-label") }}
                                        {{ form.layout(onchange="updatePreview()") }}
                                    </div>
                                    <div class="col-6">
                                        {{ form.avatar_shape.label(class="form-label") }}
                                        {{ form.avatar_shape(onchange="updatePreview()") }}
                                        <div class="form-text">
                                            <small>
                                                <i class="fas fa-info-circle me-1"></i>
                                                <strong>Rectangular:</strong> Ideal para logos y marcas
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Submit -->
                                <div class="d-grid">
                                    {{ form.submit() }}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Live Preview -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-eye me-2"></i>Vista Previa
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="preview-container" style="
                                background: linear-gradient(135deg, var(--preview-primary, {{ card.theme.primary_color }}), var(--preview-secondary, {{ card.theme.secondary_color }}));
                                min-height: 500px;
                                padding: 20px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">
                                <div id="preview-card" class="preview-card" style="
                                    max-width: 300px;
                                    width: 100%;
                                    text-align: center;
                                    font-family: var(--preview-font, '{{ card.theme.font_family }}'), sans-serif;
                                    transition: all 0.3s ease;
                                ">
                                    <!-- Avatar Preview -->
                                    <div id="preview-avatar" style="
                                        width: 80px;
                                        height: 80px;
                                        margin: 0 auto 15px;
                                        overflow: hidden;
                                        border: 3px solid {{ card.theme.avatar_border_color or '#ffffff' }};
                                        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                                        background: #f8f9fa;
                                    ">
                                        {% if card.has_avatar() %}
                                            <img id="preview-avatar-img" src="{{ card.get_avatar_url_with_cache_busting() or url_for('static', filename='uploads/' + card.get_avatar_path()) }}" 
                                                 style="width: 100%; height: 100%; object-fit: cover;" alt="Avatar">
                                        {% else %}
                                            <div class="w-100 h-100 d-flex align-items-center justify-content-center" 
                                                 style="background: linear-gradient(135deg, var(--preview-primary, {{ card.theme.primary_color }}), var(--preview-secondary, {{ card.theme.secondary_color }})); color: white; font-size: 30px;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <h3 id="preview-title" style="
                                        color: var(--preview-primary, {{ card.theme.primary_color }});
                                        font-size: 18px;
                                        font-weight: 700;
                                        margin-bottom: 5px;
                                    ">{{ card.title or card.name }}</h3>
                                    
                                    {% if card.job_title %}
                                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">{{ card.job_title }}</p>
                                    {% endif %}
                                    
                                    <div id="preview-buttons" class="preview-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                                        <div id="btn-contact" class="preview-btn" style="
                                            color: white;
                                            padding: 8px 15px;
                                            font-size: 12px;
                                            font-weight: 600;
                                            transition: all 0.3s ease;
                                        ">CONTACTO</div>
                                        
                                        <div id="btn-services" class="preview-btn" style="
                                            color: white;
                                            padding: 8px 15px;
                                            font-size: 12px;
                                            font-weight: 600;
                                            transition: all 0.3s ease;
                                        ">SERVICIOS</div>
                                        
                                        <div id="btn-outline" class="preview-btn" style="
                                            background: transparent;
                                            color: var(--preview-primary, {{ card.theme.primary_color }});
                                            padding: 8px 15px;
                                            font-size: 12px;
                                            font-weight: 600;
                                            transition: all 0.3s ease;
                                        ">UBICACIÓN</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updatePreview() {
    const primary = document.getElementById('primary_color').value;
    const secondary = document.getElementById('secondary_color').value;
    const accent = document.getElementById('accent_color').value;
    const avatarBorderColor = document.getElementById('avatar_border_color').value;
    const font = document.getElementById('font_family').value;
    const layout = document.getElementById('layout').value;
    const avatarShape = document.getElementById('avatar_shape').value;
    
    // Update CSS custom properties
    document.documentElement.style.setProperty('--preview-primary', primary);
    document.documentElement.style.setProperty('--preview-secondary', secondary);
    document.documentElement.style.setProperty('--preview-accent', accent);
    document.documentElement.style.setProperty('--preview-font', font);
    
    // Update Google Fonts dynamically
    const encodedFont = font.replace(/\s+/g, '+');
    const fontUrl = `https://fonts.googleapis.com/css2?family=${encodedFont}:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400;1,500&display=swap`;
    
    // Remove existing dynamic font link
    const existingDynamicLink = document.getElementById('dynamic-font-link');
    if (existingDynamicLink) {
        existingDynamicLink.remove();
    }
    
    // Create new font link with unique ID
    const newFontLink = document.createElement('link');
    newFontLink.id = 'dynamic-font-link';
    newFontLink.rel = 'stylesheet';
    newFontLink.href = fontUrl;
    document.head.appendChild(newFontLink);
    
    console.log('Loading font:', font, '-> URL:', fontUrl);
    
    // Apply font with a small delay to ensure loading
    setTimeout(() => {
        document.documentElement.style.setProperty('--preview-font', `'${font}'`);
        const previewCard = document.getElementById('preview-card');
        if (previewCard) {
            previewCard.style.fontFamily = `'${font}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif`;
        }
        console.log('Applied font:', font);
    }, 100);
    
    // Update card layout styles
    const previewCard = document.getElementById('preview-card');
    const avatar = document.getElementById('preview-avatar');
    const btnContact = document.getElementById('btn-contact');
    const btnServices = document.getElementById('btn-services');
    const btnOutline = document.getElementById('btn-outline');
    
    // Font is applied above with setTimeout
    
    // Apply layout-specific styles
    if (layout === 'classic') {
        // Classic layout
        previewCard.style.background = 'white';
        previewCard.style.borderRadius = '15px';
        previewCard.style.padding = '25px 20px';
        previewCard.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.1)';
        previewCard.style.border = `2px solid ${primary}20`;
        previewCard.style.backdropFilter = 'none';
        
        // Button styles for classic
        [btnContact, btnServices, btnOutline].forEach(btn => {
            btn.style.borderRadius = '8px';
            btn.style.textTransform = 'none';
            btn.style.letterSpacing = '0';
        });
        
        btnContact.style.background = primary;
        btnServices.style.background = secondary;
        btnOutline.style.border = `2px solid ${primary}`;
        
    } else if (layout === 'minimal') {
        // Minimal layout
        previewCard.style.background = 'white';
        previewCard.style.borderRadius = '0';
        previewCard.style.padding = '30px 25px';
        previewCard.style.boxShadow = 'none';
        previewCard.style.border = '1px solid #e0e0e0';
        previewCard.style.backdropFilter = 'none';
        
        // Button styles for minimal
        [btnContact, btnServices, btnOutline].forEach(btn => {
            btn.style.borderRadius = '0';
            btn.style.textTransform = 'none';
            btn.style.letterSpacing = '0';
            btn.style.fontWeight = '500';
        });
        
        btnContact.style.background = primary;
        btnServices.style.background = secondary;
        btnOutline.style.border = `1px solid ${primary}`;
        
    } else {
        // Modern layout (default)
        previewCard.style.background = 'rgba(255, 255, 255, 0.95)';
        previewCard.style.borderRadius = '30px';
        previewCard.style.padding = '30px 25px';
        previewCard.style.boxShadow = '0 25px 50px rgba(0, 0, 0, 0.2)';
        previewCard.style.border = 'none';
        previewCard.style.backdropFilter = 'blur(10px)';
        
        // Button styles for modern
        [btnContact, btnServices, btnOutline].forEach(btn => {
            btn.style.borderRadius = '20px';
            btn.style.textTransform = 'uppercase';
            btn.style.letterSpacing = '1px';
            btn.style.fontWeight = '600';
        });
        
        btnContact.style.background = `linear-gradient(135deg, ${primary}, ${secondary})`;
        btnServices.style.background = `linear-gradient(135deg, ${secondary}, ${accent})`;
        btnOutline.style.border = `2px solid ${primary}50`;
    }
    
    // Update avatar shape and border color
    const avatarImg = document.getElementById('preview-avatar-img');
    
    // Apply border color to avatar
    if (avatar) {
        avatar.style.borderColor = avatarBorderColor;
        avatar.style.borderWidth = '3px';
        avatar.style.borderStyle = 'solid';
        console.log('Avatar border color updated to:', avatarBorderColor);
    } else {
        console.error('Avatar element not found');
    }
    
    if (avatarShape === 'circle') {
        avatar.style.borderRadius = '50%';
        avatar.style.width = '80px';
        avatar.style.height = '80px';
        avatar.style.padding = '0';
        avatar.style.background = '#f8f9fa';
        if (avatarImg) avatarImg.style.objectFit = 'cover';
    } else if (avatarShape === 'rounded') {
        avatar.style.borderRadius = '20px';
        avatar.style.width = '80px';
        avatar.style.height = '80px';
        avatar.style.padding = '0';
        avatar.style.background = '#f8f9fa';
        if (avatarImg) avatarImg.style.objectFit = 'cover';
    } else if (avatarShape === 'rectangle') {
        avatar.style.borderRadius = '12px';
        avatar.style.width = '220px';
        avatar.style.height = '120px';
        avatar.style.background = 'white';
        avatar.style.padding = '10px';
        if (avatarImg) avatarImg.style.objectFit = 'contain';
    } else {
        avatar.style.borderRadius = '8px';
        avatar.style.width = '80px';
        avatar.style.height = '80px';
        avatar.style.padding = '0';
        avatar.style.background = '#f8f9fa';
        if (avatarImg) avatarImg.style.objectFit = 'cover';
    }
    
    // Convert hex to RGB for border colors
    const hexToRgb = (hex) => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    };
    
    const primaryRgb = hexToRgb(primary);
    if (primaryRgb) {
        document.documentElement.style.setProperty('--preview-primary-rgb', `${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}`);
    }
}

// Initialize preview on page load
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    
    // Handle template selection
    document.querySelectorAll('.select-template').forEach(button => {
        button.addEventListener('click', function() {
            const template = this.dataset.template;
            changeTemplate(template);
        });
    });
    
});

// Function to change template
function changeTemplate(templateName) {
    const csrfToken = document.querySelector('[name=csrf_token]').value;
    
    // Show loading state
    const button = document.querySelector(`[data-template="${templateName}"]`);
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cambiando...';
    button.disabled = true;
    
    fetch(`/dashboard/cards/{{ card.id }}/change-template`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ template_name: templateName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showMessage(data.message, 'success');
            // Reload to update presets for new template
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage('Error al cambiar plantilla: ' + data.message, 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error al cambiar plantilla', 'error');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}


// Function to show messages
function showMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
    
    // Insert at the top of the content area
    const contentArea = document.querySelector('.main-content');
    contentArea.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        const alert = contentArea.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}

// Function to apply color preset
function applyPreset(primaryColor, secondaryColor, accentColor, avatarBorderColor = '#ffffff') {
    // Update form color inputs
    const primaryInput = document.getElementById('primary_color');
    const secondaryInput = document.getElementById('secondary_color');
    const accentInput = document.getElementById('accent_color');
    const avatarBorderInput = document.getElementById('avatar_border_color');
    
    if (primaryInput) primaryInput.value = primaryColor;
    if (secondaryInput) secondaryInput.value = secondaryColor;
    if (accentInput) accentInput.value = accentColor;
    if (avatarBorderInput) avatarBorderInput.value = avatarBorderColor;
    
    // Update preview
    updatePreview();
    
    // Highlight selected palette
    document.querySelectorAll('.palette-btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-secondary');
    });
    
    // Find and highlight the clicked button
    event.target.closest('.palette-btn').classList.remove('btn-outline-secondary');
    event.target.closest('.palette-btn').classList.add('btn-primary');
}

</script>

<style>
.palette-btn {
    transition: all 0.3s ease;
    min-height: 70px;
    position: relative;
    overflow: hidden;
}

.palette-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.palette-btn:active {
    transform: translateY(0);
}

.palette-btn.btn-primary {
    border-width: 2px;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
}

.form-control[type="color"] {
    height: 40px;
    padding: 2px;
}

.preview-card {
    transition: all 0.3s ease;
}

#preview-container {
    transition: background 0.3s ease;
}
</style>
{% endblock %}