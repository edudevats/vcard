{% extends "base_pwa.html" %}

{% set active_tab = 'profile' %}
{% set show_header = true %}
{% set show_bottom_nav = true %}

{% block title %}Perfil - VCard Digital{% endblock %}

{% block content %}
<div class="p-4">
    <!-- Profile Header -->
    <div class="text-center mb-6">
        <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center">
            <span class="material-symbols-outlined text-3xl text-gray-400 dark:text-gray-500">person</span>
        </div>
        <h1 class="text-xl font-bold text-gray-900 dark:text-white">{{ current_user.email.split('@')[0] }}</h1>
        <p class="text-gray-600 dark:text-gray-400">{{ current_user.email }}</p>
    </div>

    <!-- Account Stats -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
            <div class="text-2xl font-bold text-primary mb-1">{{ current_user.cards.count() }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Tarjetas</div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
            <div class="text-2xl font-bold text-primary mb-1">{{ current_user.max_cards }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Límite</div>
        </div>
    </div>

    <!-- Settings Options -->
    <div class="space-y-3">
        <!-- Change Password -->
        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
            <button class="w-full p-4 text-left flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    onclick="toggleSection('password-section')">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary">lock</span>
                    <span class="font-medium text-gray-900 dark:text-white">Cambiar Contraseña</span>
                </div>
                <span class="material-symbols-outlined text-gray-400">expand_more</span>
            </button>
            <div id="password-section" class="hidden px-4 pb-4">
                <form method="POST" class="space-y-3">
                   {{ form.hidden_tag() }}
                   <div>
                       <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                           Contraseña Actual
                       </label>
                       <input type="password"
                              name="current_password"
                              required
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                       {% if form.current_password.errors %}
                           <div class="text-red-500 text-xs mt-1">
                               {% for error in form.current_password.errors %}{{ error }}{% endfor %}
                           </div>
                       {% endif %}
                   </div>
                   <div>
                       <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                           Nueva Contraseña
                       </label>
                       <input type="password"
                              name="new_password"
                              required
                              minlength="6"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                       {% if form.new_password.errors %}
                           <div class="text-red-500 text-xs mt-1">
                               {% for error in form.new_password.errors %}{{ error }}{% endfor %}
                           </div>
                       {% endif %}
                   </div>
                   <div>
                       <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                           Confirmar Contraseña
                       </label>
                       <input type="password"
                              name="confirm_password"
                              required
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                       {% if form.confirm_password.errors %}
                           <div class="text-red-500 text-xs mt-1">
                               {% for error in form.confirm_password.errors %}{{ error }}{% endfor %}
                           </div>
                       {% endif %}
                   </div>
                   <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-lg font-semibold hover:bg-primary/90 transition-colors">
                       Cambiar Contraseña
                   </button>
               </form>
            </div>
        </div>

        <!-- Dark Mode Toggle -->
        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary">dark_mode</span>
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">Modo Oscuro</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Cambiar apariencia</div>
                    </div>
                </div>
                <button id="dark-mode-toggle" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 dark:bg-primary transition-colors">
                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1 dark:translate-x-6"></span>
                </button>
            </div>
        </div>

        <!-- Account Info -->
        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
            <button class="w-full p-4 text-left flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    onclick="toggleSection('account-section')">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary">info</span>
                    <span class="font-medium text-gray-900 dark:text-white">Información de Cuenta</span>
                </div>
                <span class="material-symbols-outlined text-gray-400">expand_more</span>
            </button>
            <div id="account-section" class="hidden px-4 pb-4 space-y-2">
                <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                    <span class="text-gray-600 dark:text-gray-400">Email:</span>
                    <span class="text-gray-900 dark:text-white">{{ current_user.email }}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                    <span class="text-gray-600 dark:text-gray-400">Rol:</span>
                    <span class="text-gray-900 dark:text-white">{{ 'Administrador' if current_user.is_admin() else 'Usuario' }}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-gray-100 dark:border-gray-700">
                    <span class="text-gray-600 dark:text-gray-400">Estado:</span>
                    <span class="text-gray-900 dark:text-white">
                        {% if current_user.is_approved %}
                            <span class="text-green-600">Aprobado</span>
                        {% else %}
                            <span class="text-yellow-600">Pendiente</span>
                        {% endif %}
                    </span>
                </div>
                <div class="flex justify-between py-2">
                    <span class="text-gray-600 dark:text-gray-400">Miembro desde:</span>
                    <span class="text-gray-900 dark:text-white">{{ current_user.created_at.strftime('%d/%m/%Y') }}</span>
                </div>
            </div>
        </div>

        <!-- Admin Panel (if admin) -->
        {% if current_user.is_admin() %}
        <a href="{{ url_for('admin.index') }}"
           class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4 flex items-center gap-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <span class="material-symbols-outlined text-primary">admin_panel_settings</span>
            <div>
                <div class="font-medium text-gray-900 dark:text-white">Panel de Administración</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Gestionar usuarios y sistema</div>
            </div>
            <span class="material-symbols-outlined text-gray-400 ml-auto">chevron_right</span>
        </a>
        {% endif %}

        <!-- Logout -->
        <a href="{{ url_for('auth.logout') }}"
           class="bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800 p-4 flex items-center gap-3 hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors">
            <span class="material-symbols-outlined text-red-500">logout</span>
            <div>
                <div class="font-medium text-red-900 dark:text-red-100">Cerrar Sesión</div>
                <div class="text-sm text-red-700 dark:text-red-300">Salir de tu cuenta</div>
            </div>
            <span class="material-symbols-outlined text-red-400 ml-auto">chevron_right</span>
        </a>
    </div>
</div>
{% endblock %}

{% block slide_menu_content %}
<!-- Slide menu content for profile -->
<div class="py-4">
    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Configuración</h3>
    <div class="space-y-2">
        <a href="#password-section"
           onclick="toggleSection('password-section');"
           class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <span class="material-symbols-outlined text-primary">lock</span>
            <span class="font-medium">Cambiar Contraseña</span>
        </a>
        <a href="#account-section"
           onclick="toggleSection('account-section');"
           class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <span class="material-symbols-outlined text-primary">info</span>
            <span class="font-medium">Información de Cuenta</span>
        </a>
        {% if current_user.is_admin() %}
        <a href="{{ url_for('admin.index') }}"
           class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <span class="material-symbols-outlined text-primary">admin_panel_settings</span>
            <span class="font-medium">Panel Admin</span>
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.toggle('hidden');
        // Scroll to section if opening
        if (!section.classList.contains('hidden')) {
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
}

// Dark mode toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    const darkModeToggle = document.getElementById('dark-mode-toggle');

    if (darkModeToggle) {
        // Initialize toggle state based on localStorage and current state
        const savedDarkMode = localStorage.getItem('darkMode');
        const isDark = savedDarkMode === 'true' || (!savedDarkMode && window.matchMedia('(prefers-color-scheme: dark)').matches);

        // Apply initial state
        document.documentElement.classList.toggle('dark', isDark);
        updateToggleState(isDark);

        darkModeToggle.addEventListener('click', function() {
            const html = document.documentElement;
            const currentlyDark = html.classList.contains('dark');
            const newDarkState = !currentlyDark;

            html.classList.toggle('dark', newDarkState);
            localStorage.setItem('darkMode', newDarkState ? 'true' : 'false');
            updateToggleState(newDarkState);
        });

        function updateToggleState(isDark) {
            const toggle = darkModeToggle.querySelector('span');
            if (isDark) {
                darkModeToggle.classList.add('bg-primary');
                darkModeToggle.classList.remove('bg-gray-200');
                toggle.classList.add('translate-x-6');
                toggle.classList.remove('translate-x-1');
            } else {
                darkModeToggle.classList.remove('bg-primary');
                darkModeToggle.classList.add('bg-gray-200');
                toggle.classList.remove('translate-x-6');
                toggle.classList.add('translate-x-1');
            }
        }
    }
});
</script>
{% endblock %}